<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" type="text/css" href="style.css">
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.4.0/exceljs.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/babel-polyfill/6.26.0/polyfill.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.0/FileSaver.min.js"></script>
    <link rel="shortcut icon" href="favicon.ico" type="image/x-icon">

    <title>Atualização de Planilhas</title>
</head>
<body>
<h2>Atualização de Planilhas</h2>
<hr>
<div id="centralizado">
    <form>
        <label for="planilhaBase">Planilha Base (Sistema):</label>
        <input type="file" id="planilhaBase" accept=".xlsx" required>

        <br>

        <label for="planilhaDesatualizada">Planilha Desatualizada (Site):</label>
        <input type="file" id="planilhaDesatualizada" accept=".xlsx" required>

        <br>

        <button type="button" onclick="exec()">Atualizar Planilha</button>
    </form>
    <hr>
    <img src="logonk.png" id="logonk">
</div>
<br> 
<div id="loading">
    Processando...
</div>   
<script>
    function exec(){
        document.getElementById('loading').style.display = 'block';
    getDataBase(setDataBase);
}
    //"getDataBase" Esta função é responsável por obter dados da planilha base (sistema).
    function getDataBase(callback){
        const input = document.getElementById('planilhaBase');
        const file = input.files[0];

        if (!file) {
            alert('Por favor, selecione ambas as planilhas.');
            return;
        }

        const reader = new FileReader();

        reader.onload = function(e){
            const workbook = new ExcelJS.Workbook();
            workbook.xlsx.load(e.target.result).then(function(workbook){
                const worksheet = workbook.worksheets[0];

                const rows = [];


                for (let i = 1; i <= worksheet.rowCount; i++) {
                    const row = worksheet.getRow(i);
                
                    if(row.values[1] && !isNaN(row.values[1])){
                        rows.push(row.values);
                    }
                }

                callback(rows);
            });
        }

        reader.readAsBinaryString(file);
    }
    //"setDataBase" Esta função é responsável por processar a planilha desatualizada com base nos dados da planilha base.
    function setDataBase(rowsBase){
        const input = document.getElementById('planilhaDesatualizada');
        const file = input.files[0];

        if (!file) {
            alert('Por favor, selecione ambas as planilhas.');
            return;
        }

        const reader = new FileReader();

        reader.onload = function(e){
            const workbook = new ExcelJS.Workbook();
            workbook.xlsx.load(e.target.result).then(function(_workbook){
                const worksheet = _workbook.getWorksheet("Products");

                for (let i = 1; i <= worksheet.rowCount; i++) {

                    const row = worksheet.getRow(i);
                
                    const sku = row.getCell("D").value;

                    if(sku){
                        const matchedRow = rowsBase.find((baseObject) => checkEquals(row.values, baseObject));

                        if(matchedRow){
                            row.getCell("K").value = matchedRow[8];
                            row.getCell("P").value = matchedRow[9];
                            console.log(matchedRow);
                        }
                    }
                    document.getElementById('loading').style.display = 'none';
                }
                downloadFile(_workbook);
            });
        }

        reader.readAsBinaryString(file);
    }
    // "checkEquals" Esta função compara dois conjuntos de dados (uma linha de cada planilha) para verificar se um identificador específico é igual em ambos.
    function checkEquals(targetData, baseData){
        try{
            const targetId = Number(targetData[4]);
            const baseId = Number(baseData[1]);
            return targetId === baseId;
        }catch(_){
            return false;
        }
    }
    
function downloadFile(workbook){
    workbook.xlsx.writeBuffer({
                    useStyles: true,
                    useSharedStrings: true
                }).then(function (data) {
        const blob = new Blob([data],{ type: 'application/xlsx' });
        saveAs(blob,"Planilha Atualizada.xlsx");
    });
}

    //alterar o nome da tabela
    //validar se precisa de formatação no valor de preço '.' ou ','
    //loading
    //disabled_button

</script>

</body>
</html>