<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" type="text/css" href="style.css">
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.5/xlsx.full.min.js"></script>
    <link rel="shortcut icon" href="favicon.ico" type="image/x-icon">

    <title>Atualização de Planilhas</title>
</head>
<body>
<h2>Atualização de Planilhas</h2>
<hr>
<div id="centralizado">
    <form>
        <label for="planilhaBase">Planilha Base (Sistema):</label>
        <input type="file" id="planilhaBase" accept=".xlsx" required>

        <br>

        <label for="planilhaDesatualizada">Planilha Desatualizada (Site):</label>
        <input type="file" id="planilhaDesatualizada" accept=".xlsx" required>

        <br>

        <button type="button" onclick="exec()">Atualizar Planilha</button>
    </form>
    <hr>
    <img src="logonk.png" id="logonk">
</div>
<br> 
<div id="loading">
    Processando...
</div>   
<script>
    function exec(){
        document.getElementById('loading').style.display = 'block';
        getDataBase(setDataBase);
}
    //"getDataBase" Esta função é responsável por obter dados da planilha base (sistema).
    function getDataBase(callback){
        const input = document.getElementById('planilhaBase');
        const file = input.files[0];

        if (!file) {
            alert('Por favor, selecione ambas as planilhas.');
            return;
        }

        const reader = new FileReader();

        reader.onload = function(e){
            const workbook = XLSX.read(e.target.result, { type: 'binary' });
            const sheet = workbook.Sheets[workbook.SheetNames[0]];
            const excel = XLSX.utils.sheet_to_json(sheet, { raw: false, defval: null, header: 1 });

            callback(excel);
        }

        reader.readAsBinaryString(file);
    }

    //"setDataBase" Esta função é responsável por processar a planilha desatualizada com base nos dados da planilha base.
    function setDataBase(baseData){
        const input = document.getElementById('planilhaDesatualizada');
        const file = input.files[0];

        if (!file) {
            alert('Por favor, selecione ambas as planilhas.');
            return;
        }

        const reader = new FileReader();

        reader.onload = function(e){
            const workbook = XLSX.read(e.target.result, { type: 'binary' });
            const sheet = workbook.Sheets[workbook.SheetNames[0]];
            let excel = XLSX.utils.sheet_to_json(sheet, { raw: false, defval: null, header: 1 });

            for (let i = 2; i < excel.length; i++) {
                let columnIndex = 15; // 15 corresponde à coluna 'P'
                let cellReference = XLSX.utils.encode_cell({ r: i, c: columnIndex });
                
                if (sheet[cellReference]) {
                    sheet[cellReference].z = '#.##_)';
                }
            }




           for(const rowKey in excel){
                const updatedData = baseData.find(baseRow =>{
                    return checkEquals(excel[rowKey],baseRow);
                });
                
                if(updatedData){
                        const rowValue = Number(rowKey) + 1;
                        //XLSX.utils.sheet_add_aoa(sheet,[[{v:updatedData[7], t:'n'}]],{origin:"K"+rowValue});
                        XLSX.utils.sheet_add_aoa(sheet,[[updatedData[7]]],{origin:"K"+rowValue});
                        //XLSX.utils.sheet_add_aoa(sheet,[[updatedData[8]]],{origin:"P"+rowValue});
                }
                console.log(excel[5]);
           }

           workbook.Sheets[workbook.SheetNames[0]] = sheet;

           XLSX.writeFile(workbook, "planilha_atualizada.xlsx");

           document.getElementById('loading').style.display = 'none';
        }
        reader.readAsBinaryString(file);
    }

    function formatNumberLocator(Number) {
    if (Number != undefined){
        return Number.replace(',', '.');
    }
}
    // "checkEquals" Esta função compara dois conjuntos de dados (uma linha de cada planilha) para verificar se um identificador específico é igual em ambos.
    function checkEquals(targetData, baseData){
        try{
            const targetId = Number(targetData[3]);
            const baseId = Number(baseData[0]);
            return targetId === baseId;
        }catch(_){
            return false;
        }
    }
    //loading
    //disabled_button

</script>

</body>
</html>